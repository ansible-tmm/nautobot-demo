---
- name: Configure IP address on Arista device based on Nautobot data
  hosts: localhost
  gather_facts: false

  vars:
    nautobot_url: "{{ lookup('env', 'NAUTOBOT_URL') }}"
    nautobot_token: "{{ lookup('env', 'NAUTOBOT_TOKEN') }}"
    # These come from the EDA event
    ip_address: "{{ ip_address }}"  # e.g., "192.168.1.160"
    mask_length: "{{ mask_length }}" # e.g., 24

  tasks:
    - name: Look up IP address details in Nautobot
      ansible.builtin.uri:
        url: "{{ nautobot_url }}/api/ipam/ip-addresses/?address={{ ip_address }}/{{ mask_length }}"
        method: GET
        headers:
          Authorization: "Token {{ nautobot_token }}"
          Accept: "application/json"
        validate_certs: false
        return_content: true
      register: ip_lookup

    - name: Debug - Show IP lookup results
      ansible.builtin.debug:
        var: ip_lookup.json.results
        verbosity: 1

    - name: Set IP object facts
      ansible.builtin.set_fact:
        ip_obj: "{{ ip_lookup.json.results[0] }}"
      when: ip_lookup.json.results | length > 0

    - name: Fail if IP not found in Nautobot
      ansible.builtin.fail:
        msg: "IP address {{ ip_address }}/{{ mask_length }} not found in Nautobot"
      when: ip_lookup.json.results | length == 0

    - name: Extract device and interface information
      ansible.builtin.set_fact:
        device_name: "{{ ip_obj.assigned_object.device.display | default('') }}"
        interface_name: "{{ ip_obj.assigned_object.display | default('') }}"
        device_id: "{{ ip_obj.assigned_object.device.id | default('') }}"
        status: "{{ ip_obj.status.label }}"
        dns_name: "{{ ip_obj.dns_name | default('') }}"
      when:
        - ip_obj.assigned_object is defined
        - ip_obj.assigned_object.device is defined

    - name: Debug - Show extracted information
      ansible.builtin.debug:
        msg:
          - "IP Address: {{ ip_address }}/{{ mask_length }}"
          - "Assigned to Device: {{ device_name }}"
          - "Interface: {{ interface_name }}"
          - "Status: {{ status }}"
          - "DNS Name: {{ dns_name }}"

    - name: Lookup device details from Nautobot
      ansible.builtin.uri:
        url: "{{ nautobot_url }}/api/dcim/devices/{{ device_id }}/"
        method: GET
        headers:
          Authorization: "Token {{ nautobot_token }}"
          Accept: "application/json"
        validate_certs: false
        return_content: true
      register: device_lookup
      when: device_id != ''

    - name: Extract device management IP
      ansible.builtin.set_fact:
        device_mgmt_ip: "{{ device_lookup.json.primary_ip4.address | regex_replace('/.*', '') }}"
        device_platform: "{{ device_lookup.json.platform.display | default('') }}"
      when:
        - device_lookup.json is defined
        - device_lookup.json.primary_ip4 is defined

    - name: Debug - Show device details
      ansible.builtin.debug:
        msg:
          - "Device Management IP: {{ device_mgmt_ip }}"
          - "Device Platform: {{ device_platform }}"
      when: device_mgmt_ip is defined

# Now connect to the actual Arista device
- name: Configure interface on Arista device
  hosts: all
  gather_facts: false
  connection: ansible.netcommon.network_cli

  vars:
    ansible_network_os: arista.eos.eos
    ansible_user: "{{ lookup('env', 'ARISTA_USERNAME') | default('admin', true) }}"
    ansible_password: "{{ lookup('env', 'ARISTA_PASSWORD') }}"
    ansible_become: true
    ansible_become_method: enable
    ansible_host: "{{ hostvars['localhost']['device_mgmt_ip'] }}"
    interface_name: "{{ hostvars['localhost']['interface_name'] }}"
    ip_address: "{{ hostvars['localhost']['ip_address'] }}"
    mask_length: "{{ hostvars['localhost']['mask_length'] }}"

  tasks:
    - name: Skip if no management IP found
      ansible.builtin.meta: end_host
      when: ansible_host is not defined or ansible_host == ''

    - name: Get current interface configuration
      arista.eos.eos_command:
        commands:
          - "show running-config interface {{ interface_name }}"
      register: current_config
      ignore_errors: true

    - name: Display current interface config
      ansible.builtin.debug:
        var: current_config.stdout_lines

    - name: Configure IP address on interface
      arista.eos.eos_l3_interfaces:
        config:
          - name: "{{ interface_name }}"
            ipv4:
              - address: "{{ ip_address }}/{{ mask_length }}"
        state: merged
      register: config_result
      when: hostvars['localhost']['status'] == 'Active'

    - name: Show configuration result
      ansible.builtin.debug:
        var: config_result
      when: config_result is defined

    - name: Verify interface configuration
      arista.eos.eos_command:
        commands:
          - "show ip interface {{ interface_name }}"
      register: interface_status

    - name: Display interface status
      ansible.builtin.debug:
        msg:
          - "Interface {{ interface_name }} configuration:"
          - "{{ interface_status.stdout_lines[0] }}"
